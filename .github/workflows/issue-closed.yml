name: Issue Closed

on:
  issues:
    types: [closed]

jobs:
  process-closed-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Validate and handle completed issue
        if: github.event.issue.state_reason == 'completed' &&
          github.event.sender.login != 'PCL-Community-Bot'
        env:
          BOT_TOKEN: ${{ secrets.BOT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.repository.split('/')[1] }}
          SENDER: ${{ github.event.sender.login }}
        run: |
          MEMBER_CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $BOT_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/PCL-Community/members/$SENDER")

          if [ "$MEMBER_CHECK" -ne 204 ]; then
            curl -X PATCH \
              -H "Authorization: token $BOT_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER" \
              -d '{"state_reason":"not_planned"}'

            curl -f -X DELETE \
              -H "Authorization: token $BOT_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
              -d '["âŒ æ‹’ç» / æ”¾å¼ƒ","âŒ æš‚æ— è®¡åˆ’","âŒ ç¬¬ä¸‰æ–¹","âŒ é‡å¤","â­• ç­‰å¾…å¤„ç†","ğŸ˜‚ ç§»äº¤ä¸Šæ¸¸","ğŸš§ æ­£åœ¨å¤„ç†"]'

            curl -f -X POST \
              -H "Authorization: token $BOT_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
              -d '{"labels":["âŒ å¿½ç•¥"]}'
          else
            curl -f -X DELETE \
              -H "Authorization: token $BOT_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
              -d '["âŒ å¿½ç•¥","âŒ æ‹’ç» / æ”¾å¼ƒ","âŒ æš‚æ— è®¡åˆ’","âŒ ç¬¬ä¸‰æ–¹","âŒ é‡å¤","â­• ç­‰å¾…å¤„ç†","ğŸ˜‚ ç§»äº¤ä¸Šæ¸¸","ğŸš§ æ­£åœ¨å¤„ç†"]'

            curl -f -X POST \
              -H "Authorization: token $BOT_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
              -d '{"labels":["ğŸ‘Œ å®Œæˆ"]}'
          fi

      - name: Handle duplicate issue
        if: |
          github.event.issue.state_reason == 'duplicate' &&
          github.event.sender.login != 'PCL-Community-Bot'
        env:
          BOT_TOKEN: ${{ secrets.BOT }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.repository.split('/')[1] }}
        run: |
          curl -f -X DELETE \
            -H "Authorization: token $BOT_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
            -d '["âŒ å¿½ç•¥","âŒ æ‹’ç» / æ”¾å¼ƒ","âŒ æš‚æ— è®¡åˆ’","âŒ ç¬¬ä¸‰æ–¹","ğŸ‘Œ å®Œæˆ","â­• ç­‰å¾…å¤„ç†","ğŸ˜‚ ç§»äº¤ä¸Šæ¸¸","ğŸš§ æ­£åœ¨å¤„ç†"]'

          curl -f -X POST \
            -H "Authorization: token $BOT_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/issues/$ISSUE_NUMBER/labels" \
            -d '{"labels":["âŒ é‡å¤"]}'